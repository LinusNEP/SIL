version: "3.9"

services:
  sil_ros:
    image: sil_ros:gpu
    container_name: sil_ros
    network_mode: host

    gpus: all

    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - ROS_MASTER_URI=http://localhost:11311
      - ROS_HOSTNAME=localhost
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - COHERE_API_KEY=${COHERE_API_KEY}

    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ./sil_memory:/root/sil_memory
      - ./sil_config:/root/sil_config
      - ./:/root/catkin_ws/src/sil_ros

      # Optional: share Gazebo models for visualization
      - ./gazebo_models:/root/.gazebo/models

    devices:
      - /dev/snd:/dev/snd
      - /dev/video0:/dev/video0

    group_add:
      - audio
      - video

    tty: true
    stdin_open: true

    depends_on:
      - gazebo_sim


  gazebo_sim:
    image: osrf/ros:noetic-desktop-full
    container_name: gazebo_sim
    network_mode: host

    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - ROS_MASTER_URI=http://localhost:11311
      - ROS_HOSTNAME=localhost

    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ./gazebo_models:/root/.gazebo/models
      - ./sim_ws:/root/sim_ws

    # Enable GPU acceleration for Gazebo
    gpus: all

    command: >
      bash -c "
        source /opt/ros/noetic/setup.bash &&
        gazebo --verbose
      "

    tty: true
    stdin_open: true

